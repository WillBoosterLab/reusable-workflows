name: Add close comment

on:
  workflow_call:
    inputs:
      target_organization:
        required: false
        type: string

jobs:
  close-comment:
    if: ${{ !inputs.target_organization || github.repository_owner == inputs.target_organization }}
    runs-on: ${{ (!github.event.repository.private && 'ubuntu-latest') || fromJSON('["self-hosted", "medium"]') }}
    env:
      FORCE_COLOR: 3
    steps:
      - run: |
          mkdir -p temp
          echo "import { execSync } from 'node:child_process';" > temp/addCloseComment.mjs
          echo "const headRef = '${{github.head_ref}}';" >> temp/addCloseComment.mjs
          echo "const prNumber = '${{ github.event.pull_request.number }}';" >> temp/addCloseComment.mjs
          echo "const repository = '${{ github.repository }}';" >> temp/addCloseComment.mjs
          cat >> temp/addCloseComment.mjs << EOF
          const url = \`https://github.com/\${repository}/pull/\${prNumber}\`
          const [issueNumber] = headRef.split(/[-_]/);
          const closeComment = \`close #\${issueNumber}\`;
          const closeCommentRegex = new RegExp(closeComment);
          const issueNumberRegex = /^[0-9]+$/;
          if (issueNumberRegex.test(issueNumber)) {
              let newBody = "";
              const stdout = execSync(\`gh pr view \${url} --json body\`);
              let commentBody = JSON.parse(stdout)["body"];
              if (!closeCommentRegex.test(commentBody)) {
                  newBody = \`\${closeComment}\r\n\${commentBody}\`;
              }
              if (closeCommentRegex.test(newBody)) {
                  execSync(\`gh pr edit \${url} --body "\${newBody}"\`);
              }
          }
          EOF
          node temp/addCloseComment.mjs
          rm -Rf temp
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
