name: Willboosterify
on:
  workflow_call:
    inputs:
      cpu_arch:
        required: false
        type: string
      github_hosted_runner:
        required: false
        type: boolean
      target_organization:
        required: false
        type: string
    secrets:
      GH_TOKEN:
        required: true
jobs:
  wbfy:
    if: ${{ !inputs.target_organization || github.repository_owner == inputs.target_organization }}
    # github.event.repository.private is always true if job is scheduled
    runs-on: ${{ (inputs.github_hosted_runner && 'ubuntu-latest') || (inputs.cpu_arch == 'X64' && fromJSON('["self-hosted", "large", "X64"]')) || (inputs.cpu_arch == 'ARM64' && fromJSON('["self-hosted", "large", "ARM64"]')) || fromJSON('["self-hosted", "large"]') }}
    steps:
      - uses: actions/checkout@v3
        # To trigger other workflows when running 'git push'
        with:
          token: ${{ secrets.GH_TOKEN }}
      - if: ${{ inputs.dot_env_path }}
        run: echo '${{ secrets.DOT_ENV }}' > ${{ inputs.dot_env_path }}

      # We prefer actions/setup-node to asdf because asdf is slow on GitHub runners
      # However, we must use asdf if .tool-versions since it may install some tools other than Node.js
      - name: Get Node.js version
        id: get-ver
        run: |
          if [[ -f .tool-versions ]] || [[ -f .node-version ]]; then
            echo "exist-version=1" >> $GITHUB_OUTPUT
          fi
      - if: ${{ steps.get-ver.outputs.exist-version }}
        uses: willbooster/asdf-actions/install@main
      - uses: actions/setup-node@v3
      - name: Show environment information
        id: env-info
        # https://stackoverflow.com/a/677212
        run: |
          echo "node: $(node -v)"
          echo "yarn: $(yarn -v)"
          if [[ "$(yarn -v)" == "1."* ]]; then
            echo "yarn-dir=$(yarn cache dir)" >> $GITHUB_OUTPUT
          fi

      - run: yarn dlx wbfy --version && yarn dlx wbfy .
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      - run: |
          git config --global user.email "bot@willbooster.com"
          git config --global user.name "WillBooster Inc."
          git checkout -B wbfy
          git add -A
          if git commit -m "chore: willboosterify this repo"; then
            git push origin wbfy -f
          fi
        env:
          HUSKY: 0
